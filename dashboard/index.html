<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trust Infrastructure Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 { color: #fff; margin-bottom: 8px; }
    .subtitle { color: #888; margin-bottom: 24px; font-size: 14px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .card {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 16px;
    }
    .card h2 { font-size: 14px; color: #888; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
    .stat { font-size: 32px; font-weight: bold; color: #fff; }
    .stat-label { font-size: 12px; color: #666; margin-top: 4px; }
    .agent {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .agent-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .agent-name { font-size: 18px; font-weight: bold; color: #fff; }
    .agent-status { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .agent-status.active { background: #1a4d1a; color: #4ade80; }
    .agent-status.revoked { background: #4d1a1a; color: #f87171; }
    .agent-meta { font-size: 12px; color: #666; margin-bottom: 8px; }
    .agent-id { font-family: monospace; font-size: 11px; color: #555; word-break: break-all; }
    .reputation { display: flex; gap: 16px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #333; }
    .rep-item { text-align: center; }
    .rep-value { font-size: 20px; font-weight: bold; color: #60a5fa; }
    .rep-label { font-size: 10px; color: #666; text-transform: uppercase; }
    .events { margin-top: 24px; }
    .event {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .event-type { font-weight: bold; color: #fff; }
    .event-time { font-size: 12px; color: #666; }
    .event-agent { font-size: 11px; color: #888; font-family: monospace; }
    .loading { color: #666; font-style: italic; }
    .error { color: #f87171; }
    .refresh-btn {
      background: #333;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .refresh-btn:hover { background: #444; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .wren-highlight { border-color: #60a5fa; }
    .wren-highlight .agent-name { color: #60a5fa; }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>üîê Trust Infrastructure</h1>
      <p class="subtitle">Cryptographic audit trail for AI agents</p>
    </div>
    <button class="refresh-btn" onclick="loadAll()">‚Üª Refresh</button>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Agents</h2>
      <div class="stat" id="agent-count">-</div>
      <div class="stat-label">Registered agents</div>
    </div>
    <div class="card">
      <h2>Events</h2>
      <div class="stat" id="event-count">-</div>
      <div class="stat-label">Total events logged</div>
    </div>
    <div class="card">
      <h2>Service Status</h2>
      <div class="stat" id="service-status">...</div>
      <div class="stat-label" id="service-time">-</div>
    </div>
  </div>

  <h2 style="color: #fff; margin-bottom: 16px;">Agents</h2>
  <div id="agents-list"><p class="loading">Loading agents...</p></div>

  <div class="events">
    <h2 style="color: #fff; margin-bottom: 16px;">Recent Events</h2>
    <div id="events-list"><p class="loading">Loading events...</p></div>
  </div>

  <script>
    const API_BASE = 'https://trust-api.whalescope.app';

    async function loadHealth() {
      try {
        const res = await fetch(`${API_BASE}/health`);
        const data = await res.json();
        document.getElementById('service-status').textContent = data.status === 'ok' ? '‚úÖ Online' : '‚ùå Error';
        document.getElementById('service-time').textContent = new Date(data.timestamp).toLocaleString();
      } catch (e) {
        document.getElementById('service-status').textContent = '‚ùå Offline';
        document.getElementById('service-status').className = 'stat error';
      }
    }

    async function loadAgents() {
      try {
        const res = await fetch(`${API_BASE}/api/agents`);
        const data = await res.json();
        document.getElementById('agent-count').textContent = data.count;
        
        const container = document.getElementById('agents-list');
        container.innerHTML = '';
        
        for (const agent of data.agents) {
          const rep = await fetch(`${API_BASE}/api/reputation/${agent.agentId}`).then(r => r.json()).catch(() => null);
          
          const isWren = agent.name === 'Wren';
          const div = document.createElement('div');
          div.className = `agent ${isWren ? 'wren-highlight' : ''}`;
          div.innerHTML = `
            <div class="agent-header">
              <span class="agent-name">${isWren ? 'ü™∂ ' : ''}${agent.name}</span>
              <span class="agent-status ${agent.status}">${agent.status}</span>
            </div>
            <div class="agent-meta">${agent.owner} ¬∑ ${agent.metadata?.description || ''}</div>
            <div class="agent-id">${agent.agentId}</div>
            ${rep ? `
              <div class="reputation">
                <div class="rep-item">
                  <div class="rep-value">${parseFloat(rep.overallScore).toFixed(0)}</div>
                  <div class="rep-label">Score</div>
                </div>
                <div class="rep-item">
                  <div class="rep-value">${rep.totalActions}</div>
                  <div class="rep-label">Actions</div>
                </div>
                <div class="rep-item">
                  <div class="rep-value">${(parseFloat(rep.successRate) * 100).toFixed(0)}%</div>
                  <div class="rep-label">Success</div>
                </div>
              </div>
            ` : ''}
          `;
          container.appendChild(div);
        }
      } catch (e) {
        document.getElementById('agents-list').innerHTML = `<p class="error">Error loading agents: ${e.message}</p>`;
      }
    }

    async function loadEvents() {
      try {
        const res = await fetch(`${API_BASE}/api/events?limit=20`);
        const data = await res.json();
        document.getElementById('event-count').textContent = data.events?.length || 0;
        
        const container = document.getElementById('events-list');
        if (!data.events || data.events.length === 0) {
          container.innerHTML = '<p class="loading">No events yet</p>';
          return;
        }
        
        container.innerHTML = '';
        for (const event of data.events.slice(0, 10)) {
          const div = document.createElement('div');
          div.className = 'event';
          div.innerHTML = `
            <div>
              <div class="event-type">${event.eventType}</div>
              <div class="event-agent">${event.agentId.slice(0, 16)}...</div>
            </div>
            <div class="event-time">${new Date(event.timestamp).toLocaleString()}</div>
          `;
          container.appendChild(div);
        }
      } catch (e) {
        document.getElementById('events-list').innerHTML = `<p class="error">Error loading events: ${e.message}</p>`;
      }
    }

    function loadAll() {
      loadHealth();
      loadAgents();
      loadEvents();
    }

    loadAll();
    setInterval(loadAll, 30000); // Refresh every 30s
  </script>
</body>
</html>
