<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trust Infrastructure Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl-fast.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl-util@0.15.1/nacl-util.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 { color: #fff; margin-bottom: 8px; }
    .subtitle { color: #888; margin-bottom: 24px; font-size: 14px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .card {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 16px;
    }
    .card h2 { font-size: 14px; color: #888; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
    .stat { font-size: 32px; font-weight: bold; color: #fff; }
    .stat-label { font-size: 12px; color: #666; margin-top: 4px; }
    .agent {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .agent-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .agent-name { font-size: 18px; font-weight: bold; color: #fff; }
    .agent-status { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .agent-status.active { background: #1a4d1a; color: #4ade80; }
    .agent-status.revoked { background: #4d1a1a; color: #f87171; }
    .agent-meta { font-size: 12px; color: #666; margin-bottom: 8px; }
    .agent-id { font-family: monospace; font-size: 11px; color: #555; word-break: break-all; }
    .reputation { display: flex; gap: 16px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #333; }
    .rep-item { text-align: center; }
    .rep-value { font-size: 20px; font-weight: bold; color: #60a5fa; }
    .rep-label { font-size: 10px; color: #666; text-transform: uppercase; }
    .events { margin-top: 24px; }
    .event {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .event-type { font-weight: bold; color: #fff; }
    .event-time { font-size: 12px; color: #666; }
    .event-agent { font-size: 11px; color: #888; font-family: monospace; }
    .loading { color: #666; font-style: italic; }
    .error { color: #f87171; }
    .memory {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .memory.encrypted { border-color: #60a5fa; }
    .memory.decrypted { border-color: #4ade80; }
    .memory-content { font-size: 16px; color: #fff; margin-bottom: 12px; line-height: 1.5; }
    .memory-content.encrypted-text { color: #888; font-style: italic; }
    .memory-meta { display: flex; gap: 16px; flex-wrap: wrap; }
    .memory-tag {
      background: #2a2a2a;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      color: #888;
    }
    .memory-tag.kind { background: #1a3d1a; color: #4ade80; }
    .memory-tag.subject { background: #1a2d4d; color: #60a5fa; }
    .memory-tag.correction { background: #4d2d1a; color: #f59e0b; }
    .memory-tag.encrypted { background: #2d1a4d; color: #a78bfa; }
    .memory-tag.decrypted { background: #1a4d2d; color: #4ade80; }
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .empty-state-icon { font-size: 48px; margin-bottom: 12px; }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .tab {
      background: #1a1a1a;
      border: 1px solid #333;
      color: #888;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .tab:hover { background: #2a2a2a; }
    .tab.active { background: #333; color: #fff; border-color: #60a5fa; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .refresh-btn {
      background: #333;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .refresh-btn:hover { background: #444; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .wren-highlight { border-color: #60a5fa; }
    .wren-highlight .agent-name { color: #60a5fa; }
    
    /* Owner Mode Styles */
    .owner-panel {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border: 1px solid #0f3460;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
    }
    .owner-panel h3 {
      color: #e94560;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .owner-status {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .owner-status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    .owner-status-badge.locked { background: #4d1a1a; color: #f87171; }
    .owner-status-badge.unlocked { background: #1a4d1a; color: #4ade80; }
    .key-input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .key-input {
      flex: 1;
      background: #0a0a0a;
      border: 1px solid #333;
      color: #fff;
      padding: 10px 12px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 13px;
    }
    .key-input:focus { outline: none; border-color: #60a5fa; }
    .key-btn {
      background: #e94560;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .key-btn:hover { background: #ff6b6b; }
    .key-btn.clear { background: #333; }
    .key-btn.clear:hover { background: #444; }
    .owner-warning {
      font-size: 11px;
      color: #888;
      margin-top: 8px;
    }
    .decrypt-stats {
      display: flex;
      gap: 24px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #333;
    }
    .decrypt-stat {
      text-align: center;
    }
    .decrypt-stat-value { font-size: 24px; font-weight: bold; color: #4ade80; }
    .decrypt-stat-label { font-size: 11px; color: #888; }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>üîê Trust Infrastructure</h1>
      <p class="subtitle">Cryptographic audit trail for AI agents</p>
    </div>
    <button class="refresh-btn" onclick="loadAll()">‚Üª Refresh</button>
  </div>

  <!-- Owner Mode Panel -->
  <div class="owner-panel">
    <h3>üîë Owner Mode</h3>
    <div class="owner-status">
      <span id="owner-status-badge" class="owner-status-badge locked">üîí Locked</span>
      <span id="owner-status-text" style="color: #888; font-size: 13px;">Enter your secret key to decrypt private memories</span>
    </div>
    <div class="key-input-group">
      <input type="password" id="secret-key-input" class="key-input" placeholder="Paste your secret key (base64)..." />
      <button class="key-btn" onclick="unlockOwnerMode()">Unlock</button>
      <button class="key-btn clear" onclick="lockOwnerMode()">Clear</button>
    </div>
    <p class="owner-warning">‚ö†Ô∏è Your key is stored in browser memory only. Never share your secret key.</p>
    <div id="decrypt-stats" class="decrypt-stats" style="display: none;">
      <div class="decrypt-stat">
        <div class="decrypt-stat-value" id="decrypted-count">0</div>
        <div class="decrypt-stat-label">Decrypted</div>
      </div>
      <div class="decrypt-stat">
        <div class="decrypt-stat-value" id="encrypted-count">0</div>
        <div class="decrypt-stat-label">Encrypted Total</div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Agents</h2>
      <div class="stat" id="agent-count">-</div>
      <div class="stat-label">Registered agents</div>
    </div>
    <div class="card">
      <h2>Events</h2>
      <div class="stat" id="event-count">-</div>
      <div class="stat-label">Total events logged</div>
    </div>
    <div class="card">
      <h2>Service Status</h2>
      <div class="stat" id="service-status">...</div>
      <div class="stat-label" id="service-time">-</div>
    </div>
  </div>

  <h2 style="color: #fff; margin-bottom: 16px;">Agents</h2>
  <div id="agents-list"><p class="loading">Loading agents...</p></div>

  <h2 style="color: #fff; margin-bottom: 16px;">Memories & Events</h2>
  <div class="tabs">
    <button class="tab active" onclick="showTab('memories')">üß† Memories</button>
    <button class="tab" onclick="showTab('events')">üìã All Events</button>
  </div>

  <div id="memories-tab" class="tab-content active">
    <div id="memories-list"><p class="loading">Loading memories...</p></div>
  </div>

  <div id="events-tab" class="tab-content">
    <div id="events-list"><p class="loading">Loading events...</p></div>
  </div>

  <script>
    const API_BASE = 'https://trust-infra.fly.dev';
    let ownerSecretKey = null;

    // Decryption function
    function decryptContent(ciphertext, nonce, secretKey) {
      try {
        const secretKeyBytes = nacl.util.decodeBase64(secretKey);
        const combined = nacl.util.decodeBase64(ciphertext);
        const nonceBytes = nacl.util.decodeBase64(nonce);
        
        // Extract ephemeral public key and ciphertext
        const ephemeralPublicKey = combined.slice(0, nacl.box.publicKeyLength);
        const encryptedData = combined.slice(nacl.box.publicKeyLength);
        
        // Decrypt
        const messageBytes = nacl.box.open(
          encryptedData,
          nonceBytes,
          ephemeralPublicKey,
          secretKeyBytes
        );
        
        if (!messageBytes) {
          return null;
        }
        
        return nacl.util.encodeUTF8(messageBytes);
      } catch (e) {
        console.error('Decryption failed:', e);
        return null;
      }
    }

    function unlockOwnerMode() {
      const input = document.getElementById('secret-key-input');
      const key = input.value.trim();
      
      if (!key) {
        alert('Please enter your secret key');
        return;
      }
      
      // Test if it's a valid base64 key
      try {
        const decoded = nacl.util.decodeBase64(key);
        if (decoded.length !== 32) {
          alert('Invalid key length. Expected 32 bytes.');
          return;
        }
      } catch (e) {
        alert('Invalid base64 encoding');
        return;
      }
      
      ownerSecretKey = key;
      document.getElementById('owner-status-badge').className = 'owner-status-badge unlocked';
      document.getElementById('owner-status-badge').textContent = 'üîì Unlocked';
      document.getElementById('owner-status-text').textContent = 'Decrypting private memories...';
      document.getElementById('decrypt-stats').style.display = 'flex';
      input.value = '';
      input.placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
      
      // Reload memories with decryption
      loadMemories();
    }

    function lockOwnerMode() {
      ownerSecretKey = null;
      document.getElementById('owner-status-badge').className = 'owner-status-badge locked';
      document.getElementById('owner-status-badge').textContent = 'üîí Locked';
      document.getElementById('owner-status-text').textContent = 'Enter your secret key to decrypt private memories';
      document.getElementById('decrypt-stats').style.display = 'none';
      document.getElementById('secret-key-input').placeholder = 'Paste your secret key (base64)...';
      
      // Reload memories without decryption
      loadMemories();
    }

    async function loadHealth() {
      try {
        const res = await fetch(`${API_BASE}/health`);
        const data = await res.json();
        document.getElementById('service-status').textContent = data.status === 'ok' ? '‚úÖ Online' : '‚ùå Error';
        document.getElementById('service-time').textContent = new Date(data.timestamp).toLocaleString();
      } catch (e) {
        document.getElementById('service-status').textContent = '‚ùå Offline';
        document.getElementById('service-status').className = 'stat error';
      }
    }

    async function loadAgents() {
      try {
        const res = await fetch(`${API_BASE}/api/agents`);
        const data = await res.json();
        document.getElementById('agent-count').textContent = data.count;
        
        const container = document.getElementById('agents-list');
        container.innerHTML = '';
        
        for (const agent of data.agents) {
          const rep = await fetch(`${API_BASE}/api/reputation/${agent.agentId}`).then(r => r.json()).catch(() => null);
          
          const isWren = agent.name === 'Wren';
          const div = document.createElement('div');
          div.className = `agent ${isWren ? 'wren-highlight' : ''}`;
          div.innerHTML = `
            <div class="agent-header">
              <span class="agent-name">${isWren ? 'ü™∂ ' : ''}${agent.name}</span>
              <span class="agent-status ${agent.status}">${agent.status}</span>
            </div>
            <div class="agent-meta">${agent.owner} ¬∑ ${agent.metadata?.description || ''}</div>
            <div class="agent-id">${agent.agentId}</div>
            ${rep ? `
              <div class="reputation">
                <div class="rep-item">
                  <div class="rep-value">${parseFloat(rep.overallScore).toFixed(0)}</div>
                  <div class="rep-label">Score</div>
                </div>
                <div class="rep-item">
                  <div class="rep-value">${rep.totalActions}</div>
                  <div class="rep-label">Actions</div>
                </div>
                <div class="rep-item">
                  <div class="rep-value">${(parseFloat(rep.successRate) * 100).toFixed(0)}%</div>
                  <div class="rep-label">Success</div>
                </div>
              </div>
            ` : ''}
          `;
          container.appendChild(div);
        }
      } catch (e) {
        document.getElementById('agents-list').innerHTML = `<p class="error">Error loading agents: ${e.message}</p>`;
      }
    }

    async function loadEvents() {
      try {
        const res = await fetch(`${API_BASE}/api/events?limit=20`);
        const data = await res.json();
        document.getElementById('event-count').textContent = data.total || data.events?.length || 0;
        
        const container = document.getElementById('events-list');
        if (!data.events || data.events.length === 0) {
          container.innerHTML = '<p class="loading">No events yet</p>';
          return;
        }
        
        container.innerHTML = '';
        for (const event of data.events.slice(0, 10)) {
          const div = document.createElement('div');
          div.className = 'event';
          div.innerHTML = `
            <div>
              <div class="event-type">${event.eventType}</div>
              <div class="event-agent">${event.agentId.slice(0, 16)}...</div>
            </div>
            <div class="event-time">${new Date(event.timestamp).toLocaleString()}</div>
          `;
          container.appendChild(div);
        }
      } catch (e) {
        document.getElementById('events-list').innerHTML = `<p class="error">Error loading events: ${e.message}</p>`;
      }
    }

    async function loadMemories() {
      try {
        const res = await fetch(`${API_BASE}/api/events?limit=100`);
        const data = await res.json();
        
        // Filter for memory events
        const memories = (data.events || []).filter(e => e.eventType === 'memory_created');
        
        const container = document.getElementById('memories-list');
        if (memories.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üß†</div>
              <p>No memories logged yet</p>
              <p style="font-size: 12px; margin-top: 8px;">Facts and corrections will appear here once logged</p>
            </div>
          `;
          return;
        }
        
        let encryptedCount = 0;
        let decryptedCount = 0;
        
        container.innerHTML = '';
        for (const memory of memories) {
          const payload = memory.payload || {};
          const div = document.createElement('div');
          
          const isEncrypted = payload.encrypted === true;
          let content = payload.content || 'No content';
          let decrypted = false;
          
          if (isEncrypted) {
            encryptedCount++;
            if (ownerSecretKey && payload.ciphertext && payload.nonce) {
              const decryptedContent = decryptContent(payload.ciphertext, payload.nonce, ownerSecretKey);
              if (decryptedContent) {
                content = decryptedContent;
                decrypted = true;
                decryptedCount++;
              }
            }
          }
          
          div.className = `memory ${isEncrypted ? (decrypted ? 'decrypted' : 'encrypted') : ''}`;
          
          const kindClass = payload.kind === 'correction' ? 'correction' : 'kind';
          const supersedes = payload.supersedes ? `<span class="memory-tag correction">supersedes: ${payload.supersedes}</span>` : '';
          const encryptionTag = isEncrypted 
            ? (decrypted 
                ? '<span class="memory-tag decrypted">üîì decrypted</span>' 
                : '<span class="memory-tag encrypted">üîê encrypted</span>')
            : '';
          
          div.innerHTML = `
            <div class="memory-content ${isEncrypted && !decrypted ? 'encrypted-text' : ''}">"${content}"</div>
            <div class="memory-meta">
              <span class="memory-tag ${kindClass}">${payload.kind || 'unknown'}</span>
              ${payload.subject ? `<span class="memory-tag subject">about: ${payload.subject}</span>` : ''}
              ${encryptionTag}
              ${supersedes}
              <span class="memory-tag">${new Date(memory.timestamp).toLocaleString()}</span>
            </div>
          `;
          container.appendChild(div);
        }
        
        // Update stats
        document.getElementById('encrypted-count').textContent = encryptedCount;
        document.getElementById('decrypted-count').textContent = decryptedCount;
        
        if (ownerSecretKey) {
          document.getElementById('owner-status-text').textContent = 
            `Decrypted ${decryptedCount} of ${encryptedCount} encrypted memories`;
        }
      } catch (e) {
        document.getElementById('memories-list').innerHTML = `<p class="error">Error loading memories: ${e.message}</p>`;
      }
    }

    function showTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    function loadAll() {
      loadHealth();
      loadAgents();
      loadEvents();
      loadMemories();
    }

    loadAll();
    setInterval(loadAll, 30000); // Refresh every 30s
  </script>
</body>
</html>
